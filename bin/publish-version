#!/bin/bash

BRANCH=$(git rev-parse --abbrev-ref HEAD)
DIFF=$(git diff HEAD)
ROOT=$(git rev-parse --show-toplevel)


if [[ -n $DIFF ]]; then

  echo 'There are unstaged changed, please commit changes before publishing'
  exit 1
fi

if [[ -z $npm_package_version ]]; then

  echo 'Unable to determine package version to publish'
  exit 1
fi

cd $ROOT

if [[ $BRANCH != 'develop' ]]; then
  git checkout develop
fi

yarn build

if [[ $? != 0 ]]; then
  echo
  echo "Unsuccessful build... Bailing"
  echo
  exit 1
fi

yarn test

if [[ $? != 0 ]]; then
  echo
  echo "Unsuccessful tests... Bailing"
  echo
  exit 1
fi

git push
git checkout master
git merge develop

for pkg in ./modules/*; do
  if [[ -d $pkg ]]; then
    yarn publish --access public --new-version $npm_package_version $pkg
  fi
done

git push
git tag -a $npm_package_version -m "Released $npm_package_version"
git push origin $npm_package_version

git checkout $BRANCH
